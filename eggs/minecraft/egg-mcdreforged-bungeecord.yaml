_comment: "DO NOT EDIT: FILE GENERATED AUTOMATICALLY BY PANEL"
meta:
  version: PLCN_v2
  update_url: null
name: MCDReforged-BungeeCord
author: no-reply@bluefunny.email
description: "一个简洁高效且兼容性极强的 MCDReforged 运行环境 (BungeeCord / Waterfall 专版)"
tags: "{}"
features:
  - eula
docker_images:
  "Java 21": "bluefunny/pelican-yolks:mcdr-21-latest"
  "Java 17": "bluefunny/pelican-yolks:mcdr-17-latest"
  "Java 11": "bluefunny/pelican-yolks:mcdr-11-latest"
  "Java 8": "bluefunny/pelican-yolks:mcdr-8-latest"
file_denylist:
  - config.yml
  - .mcdr_installed
startup: "python3 -m mcdreforged"
config:
  files: "{}"
  startup:
    done: "Listening on"
  logs: "{}"
  stop: stop
scripts:
  installation:
    script: |-
      #!/bin/bash
      # Pterodactyl MCDReforged Egg - Installation Script

      cd /mnt/server || exit

      echo "检查旧的服务端文件..."
      if [ -n "$(find . -maxdepth 1 -mindepth 1 -not -name 'old')" ]; then
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARCHIVE_DIR="old/${TIMESTAMP}"
          echo "发现旧文件, 正在备份至 ${ARCHIVE_DIR} ..."
          mkdir -p "${ARCHIVE_DIR}"
          find . -maxdepth 1 -mindepth 1 -not -name "old" -exec mv -t "${ARCHIVE_DIR}" {} +
          echo "旧文件备份完成"
      else
          echo "未检测到旧文件, 跳过备份"
      fi

      echo "正在创建用户说明文件 (readme.txt)..."
      cat <<'EOF' > readme.txt
      欢迎使用 BlueFunny 的服务器面板!

      检测到您使用了 BungeeCord 专用模板, 此模板仅用于启动 BungeeCord 和 Waterfall 服务端及其衍生服务端, 无法启动其他服务端!
      如果您是不小心选择了此模板, 请尝试联系 BlueFunny

      # 注意
      为了保证服务器的正常运行, 我们已禁止您修改位于服务器根目录的 'config.yml' 文件
      此文件中大部分常用配置均可通过面板的 "Startup" 页面上的环境变量进行管理, 如您需要修改一些非常用配置, 请联系 BlueFunny

      # 如何配置服务器?
      1. 前往 'server/' 目录上传你的服务端文件
      2. 使用 "Startup" 页面的各种环境变量调整好你的 MCDReforged 配置
      3. 使用 "Console" 页面的 "Start" 按钮启动服务器
      4. 使用 "Console" 页面的 "Address" 标签栏的值作为服务器的 IP 地址

      # 故障排查
      1.  检查 "Startup" 页面上的环境变量: 确保所有设置, 特别是 `SERVER_JARFILE` 和 `MCDR_HANDLER` 是正确的
      2.  检查 `server/` 目录: 确保您的服务端文件已完整上传
      3.  查看控制台日志: 启动时发生的任何错误都会在此显示
      4.  [BungeeCord/Waterfall 用户] 确认服务端: 确保使用了 BungeeCord 或 Waterfall 或基于二者的服务端

      如果问题无法解决, 请尝试使用 "Settings" -> "Reinstall Server" 功能来重装服务器 (数据会被备份到当前文件夹下的 'old' 目录中)
      EOF

      echo "正在创建 JVM 参数文件 (args.txt)..."
      cat <<EOF > args.txt
      -Duser.language=en
      -Duser.country=US
      -XX:+UseG1GC
      -XX:+ParallelRefProcEnabled
      -XX:MaxGCPauseMillis=200
      -XX:+UnlockExperimentalVMOptions
      -XX:+DisableExplicitGC
      -XX:+AlwaysPreTouch
      -XX:G1NewSizePercent=30
      -XX:G1MaxNewSizePercent=40
      -XX:G1HeapRegionSize=8M
      -XX:G1ReservePercent=20
      -XX:G1HeapWastePercent=5
      -XX:G1MixedGCCountTarget=4
      -XX:InitiatingHeapOccupancyPercent=15
      -XX:G1MixedGCLiveThresholdPercent=90
      -XX:G1RSetUpdatingPauseTimePercent=5
      -XX:SurvivorRatio=32
      -XX:+PerfDisableSharedMem
      -XX:MaxTenuringThreshold=1
      EOF

      mkdir -p server

      echo "-----------------------------------------"
      echo "基础环境配置完成！"
      echo ""
      echo "接下来, 请阅读在根目录自动生成的 'readme.txt' 文件"
      echo "然后跟随其中的指引配置好服务器即可开启属于你自己的新天地!"
      echo ""
      echo "[重要] 检测到你选择了 BungeeCord 专用模板"
      echo "此模板仅用于启动 BungeeCord 和 Waterfall 服务端, 无法启动其他服务端!"
      echo "(可启动的服务端包含基于此类服务端进行修改的服务端, 例如 NullCordX)"
      echo "-----------------------------------------"

      exit 0
    container: "mcdreforged/mcdreforged:latest-slim"
    entrypoint: bash
variables:
  - sort: 1
    name: 服务端核心文件名
    description: "Minecraft 服务端核心文件名 / 这将直接关乎于您的服务器是否能够启动"
    env_variable: SERVER_JARFILE
    default_value: server.jar
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
  - sort: 2
    name: "服务端可占用最大内存 (只读)"
    description: "分配给 Minecraft 服务端的最大内存"
    env_variable: JAVA_MEMORY
    default_value: 1G
    user_viewable: true
    user_editable: false
    rules:
      - required
      - string
  - sort: 3
    name: "MCDR 处理器类型"
    description: "MCDReforged 解析服务端日志时采用的处理器类型 (特殊模板)"
    env_variable: MCDR_HANDLER
    default_value: vanilla_handler
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - "in:bungeecord_handler,waterfall_handler"
  - sort: 4
    name: "MCDR 语言"
    description: |-
      MCDReforged 显示信息所使用的语言 / 部分 MCDReforged
      插件也会采用此值来决定其显示信息所使用的语言
    env_variable: MCDR_LANGUAGE
    default_value: zh_cn
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - "in:zh_cn,zh_tw,en_us"
  - sort: 5
    name: "MCDR 日志包含服务端输出"
    description: "是否要在 MCDReforged 的日志中包含服务端输出 / 可能会导致日志文件异常增长"
    env_variable: MCDR_LOG_SERVER_OUTPUT
    default_value: false
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - "in:true,false"
  - sort: 6
    name: "[高级] MCDR 控制台编码"
    description: "设置 MCDReforged 向控制台发送信息时所使用的编码"
    env_variable: MCDR_ENCODING
    default_value: utf8
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
  - sort: 7
    name: "[高级] MCDR 控制台解码编码"
    description: "设置 MCDReforged 从控制台接受信息时所使用的编码"
    env_variable: MCDR_DECODING
    default_value: utf8
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
  - sort: 8
    name: "[高级] MCDR RCON 功能"
    description: |-
      是否启用 MCDReforged 的 RCON 功能 / 某些软件可能需要通过 RCON
      与服务器进行更深度的交互
    env_variable: MCDR_RCON_ENABLED
    default_value: false
    user_viewable: true
    user_editable: true
    rules:
      - required
      - string
      - "in:true,false"
  - sort: 9
    name: "[高级] MCDR RCON 端口"
    description: |-
      MCDReforged RCON 功能使用的端口 / 请确保这个端口没有被占用, 并且在 "Network"
      标签页中分配了该端口
    env_variable: MCDR_RCON_PORT
    default_value: "25568"
    user_viewable: true
    user_editable: true
    rules:
      - required
      - numeric
      - "between:1024,65535"
  - sort: 10
    name: "[高级] MCDR RCON 连接密码"
    description: "MCDReforged RCON 功能的连接密码"
    env_variable: MCDR_RCON_PASSWORD
    default_value: ""
    user_viewable: true
    user_editable: true
    rules:
      - nullable
      - string
      - "min:8"
  - sort: 11
    name: "[高级] PIP 参数"
    description: "为 MCDReforged 插件安装 Python 依赖时指定一些额外的参数, 例如替换镜像源"
    env_variable: PIP_ARGS
    default_value: "-i https://pypi.tuna.tsinghua.edu.cn/simple"
    user_viewable: true
    user_editable: true
    rules:
      - nullable
      - string
  - sort: 12
    name: "[调试] MCDR START HOOK 日志"
    description: "使镜像的 START HOOK 功能输出 DEBUG 级别日志"
    env_variable: DEBUG_START_HOOK
    default_value: "false"
    user_viewable: false
    user_editable: false
    rules:
      - nullable
      - "in:true,false"
